version: '3.8'

services:
  # PostgreSQL + TimescaleDB
  postgresql:
    image: timescale/timescaledb:latest-pg15
    container_name: assembly_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-assembly_tracking}
      POSTGRES_USER: ${POSTGRES_USER:-assembly_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_in_production}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/init-db:/docker-entrypoint-initdb.d
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-assembly_user}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: assembly_qdrant
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - ./data/qdrant:/qdrant/storage
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 10 bash -c ':> /dev/tcp/127.0.0.1/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: assembly_redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-change_me_redis_password}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a change_me_redis_password ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Ollama (DeepSeek-R1:14B) - CPU MODE
  ollama:
    image: ollama/ollama:latest
    container_name: assembly_ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ./data/ollama:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
      # CPU mode - no GPU
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    networks:
      - app-network
    restart: unless-stopped
    # No health check - optional service for Phase 1

  # Main Application - CPU MODE
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: assembly_app
    depends_on:
      postgresql:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      ollama:
        condition: service_started
    environment:
      # Database
      - POSTGRES_HOST=postgresql
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-assembly_tracking}
      - POSTGRES_USER=${POSTGRES_USER:-assembly_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-change_me_in_production}

      # Qdrant
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-change_me_redis_password}

      # Ollama
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=deepseek-r1:14b

      # Application
      - APP_ENV=${APP_ENV:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1

      # CPU mode
      - DETECTION_DEVICE=cpu
    ports:
      - "${APP_PORT:-8000}:8000"
    volumes:
      - ./src:/app/src
      - ./config:/app/config
      - ./logs:/app/logs
      - ./data/recordings:/app/data/recordings
      # Mount camera devices (if using USB cameras)
      # - /dev:/dev
    # devices:
    #   # USB cameras (adjust as needed)
    #   - /dev/video0:/dev/video0
    #   - /dev/video1:/dev/video1
    # privileged: true  # Required for camera access
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge
