┌─────────────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │   PyQt6 UI   │  │  REST API    │  │  WebSocket   │              │
│  │  Dashboard   │  │  (FastAPI)   │  │  Real-time   │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
│         │                  │                  │                       │
└─────────┼──────────────────┼──────────────────┼───────────────────────┘
          │                  │                  │
┌─────────┼──────────────────┼──────────────────┼───────────────────────┐
│         │         APPLICATION LAYER           │                       │
├─────────┴──────────────────┴──────────────────┴───────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────────────────────────────┐      │
│  │           Query Router & Orchestrator                       │      │
│  │  - Route queries to SQL vs Vector DB                       │      │
│  │  - Coordinate hybrid searches                              │      │
│  │  - Manage LLM interactions                                 │      │
│  └────────────┬───────────────────────────────┬────────────────┘      │
│               │                               │                        │
│               ▼                               ▼                        │
│  ┌────────────────────────┐     ┌────────────────────────┐           │
│  │  Business Logic Layer  │     │   RAG Engine           │           │
│  │  - Time tracking       │     │   - Query embedding    │           │
│  │  - Zone management     │     │   - Context retrieval  │           │
│  │  - Index calculation   │     │   - Prompt engineering │           │
│  │  - Alert generation    │     │   - Response synthesis │           │
│  └───────────┬────────────┘     └───────────┬────────────┘           │
│              │                              │                         │
└──────────────┼──────────────────────────────┼─────────────────────────┘
               │                              │
┌──────────────┼──────────────────────────────┼─────────────────────────┐
│              │      AI/ML LAYER             │                         │
├──────────────┴──────────────────────────────┴─────────────────────────┤
│                                                                         │
│  ┌───────────────────────┐  ┌───────────────────────┐                │
│  │   Computer Vision     │  │   Embedding Models    │                │
│  │                       │  │                       │                │
│  │  ┌─────────────────┐ │  │  ┌─────────────────┐ │                │
│  │  │  YOLOv8/v9      │ │  │  │ Sentence Trans  │ │                │
│  │  │  Person Detect  │ │  │  │ paraphrase-     │ │                │
│  │  └─────────────────┘ │  │  │ multilingual-   │ │                │
│  │                       │  │  │ mpnet-base-v2   │ │                │
│  │  ┌─────────────────┐ │  │  └─────────────────┘ │                │
│  │  │  DeepSORT/      │ │  │         OR            │                │
│  │  │  ByteTrack      │ │  │  ┌─────────────────┐ │                │
│  │  │  Tracking       │ │  │  │ Thai-specific   │ │                │
│  │  └─────────────────┘ │  │  │ WangchanBERTa   │ │                │
│  │                       │  │  └─────────────────┘ │                │
│  │  ┌─────────────────┐ │  │                       │                │
│  │  │  Motion         │ │  └───────────────────────┘                │
│  │  │  Detection      │ │                                            │
│  │  └─────────────────┘ │  ┌───────────────────────┐                │
│  └───────────────────────┘  │   Local LLM           │                │
│                              │                       │                │
│  ┌───────────────────────┐  │  ┌─────────────────┐ │                │
│  │   Sequence Model      │  │  │ Llama 3.1 8B    │ │                │
│  │   - Process validity  │  │  │      OR         │ │                │
│  │   - Step recognition  │  │  │ Qwen 2.5 7B     │ │                │
│  │   - Anomaly scoring   │  │  │      OR         │ │                │
│  └───────────────────────┘  │  │ Mistral 7B      │ │                │
│                              │  └─────────────────┘ │                │
│                              │  - LangChain/LlamaIdx│                │
│                              │  - Ollama runtime    │                │
│                              └───────────────────────┘                │
└─────────────────────────────────────────────────────────────────────┘
               │                              │
┌──────────────┼──────────────────────────────┼─────────────────────────┐
│              │      DATA LAYER              │                         │
├──────────────┴──────────────────────────────┴─────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────┐          │
│  │              PostgreSQL + TimescaleDB                    │          │
│  │              (Operational Data Store)                    │          │
│  │                                                          │          │
│  │  Tables:                                                 │          │
│  │  ├─ workers (id, name, badge_id, face_embedding)        │          │
│  │  ├─ time_logs (worker_id, zone_id, timestamp, duration) │          │
│  │  ├─ index_records (index_num, worker_id, completion)    │          │
│  │  ├─ zones (camera_id, polygon_coords, name)             │          │
│  │  ├─ alerts (type, severity, timestamp, context)         │          │
│  │  ├─ anomalies (pattern, description, resolution)        │          │
│  │  └─ camera_configs (rtsp_url, status, calibration)      │          │
│  └─────────────────────────────────────────────────────────┘          │
│                              │                                         │
│                              │ ETL Pipeline                            │
│                              ▼                                         │
│  ┌─────────────────────────────────────────────────────────┐          │
│  │                   Qdrant Vector DB                       │          │
│  │              (Knowledge & Pattern Store)                 │          │
│  │                                                          │          │
│  │  Collections:                                            │          │
│  │                                                          │          │
│  │  1️⃣ work_sequences (384-768 dims)                       │          │
│  │     - Standard process steps                            │          │
│  │     - Best practice sequences                           │          │
│  │     - Payload: {steps, duration, quality_score}         │          │
│  │                                                          │          │
│  │  2️⃣ anomaly_patterns (384-768 dims)                     │          │
│  │     - Historical anomalies                              │          │
│  │     - Root causes & solutions                           │          │
│  │     - Payload: {description, cause, fix, timestamp}     │          │
│  │                                                          │          │
│  │  3️⃣ knowledge_base (384-768 dims)                       │          │
│  │     - Work instructions (Thai/English)                  │          │
│  │     - Troubleshooting guides                            │          │
│  │     - Safety procedures                                 │          │
│  │     - Training materials                                │          │
│  │     - Payload: {doc_type, content, metadata}            │          │
│  │                                                          │          │
│  │  4️⃣ worker_behaviors (384-768 dims)                     │          │
│  │     - Normal activity patterns                          │          │
│  │     - Skill profiles                                    │          │
│  │     - Performance baselines                             │          │
│  │     - Payload: {worker_id, pattern_type, metrics}       │          │
│  │                                                          │          │
│  │  5️⃣ incident_reports (384-768 dims)                     │          │
│  │     - Past incidents                                    │          │
│  │     - Resolution steps                                  │          │
│  │     - Lessons learned                                   │          │
│  │     - Payload: {date, severity, resolution, impact}     │          │
│  │                                                          │          │
│  │  Features:                                               │          │
│  │  ✓ HNSW indexing for fast search                        │          │
│  │  ✓ Filtered search (by date, zone, worker)             │          │
│  │  ✓ Hybrid search (dense + sparse)                       │          │
│  │  ✓ Multi-vector support                                │          │
│  └─────────────────────────────────────────────────────────┘          │
│                              │                                         │
│  ┌───────────────────────────┴──────────────────────────┐            │
│  │                    Redis Cache                        │            │
│  │  - Real-time tracking state                          │            │
│  │  - Active worker sessions                            │            │
│  │  - Recent embeddings cache                           │            │
│  │  - Rate limiting                                     │            │
│  └──────────────────────────────────────────────────────┘            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────┘
               │
┌──────────────┼─────────────────────────────────────────────────────────┐
│              │      INFRASTRUCTURE LAYER                               │
├──────────────┴─────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐           │
│  │   Camera       │  │   Monitoring   │  │   Backup       │           │
│  │   Input Pool   │  │   - Prometheus │  │   - PostgreSQL │           │
│  │   (4 streams)  │  │   - Grafana    │  │   - Qdrant     │           │
│  │   Thread Mgmt  │  │   - Logging    │  │   Auto-daily   │           │
│  └────────────────┘  └────────────────┘  └────────────────┘           │
│                                                                          │
└──────────────────────────────────────────────────────────────────────┘
